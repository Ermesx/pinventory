@page "/tags"
@using System.Net
@using Humanizer
@using Pinventory.Web.ApiClients.Pins.GeneratedCode
@using Pinventory.Web.ApiClients.Pins.GeneratedCode.Contracts
@using Pinventory.Web.Components.Shared
@using Pinventory.Web.Components.Tags
@using Pinventory.Web.Google
@using Refit
@using static Shared.AlertMessage
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer

@inject IPinsHttpClient PinsClient
@inject IGoogleUserService GoogleUserService

<PageTitle>Manage Tags</PageTitle>

<h1>Manage Tags</h1>

<AlertMessage Message="@errorMessage" Type="AlertType.Error" OnDismiss="DismissError" />
<AlertMessage Message="@successMessage" Type="AlertType.Success" OnDismiss="DismissSuccess" />

@if (isLoading)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-xl-8">
            <p class="text-muted">
                Manage your personal tag catalog. Tags can be used to categorize your starred places.
            </p>

            <TagForm IsProcessing="@isProcessing" Tags="@tags" OnSubmit="OnAddTagAsync"/>

            <TagList Tags="@tags" IsProcessing="@isProcessing" OnRemoveTag="OnRemoveTagAsync" />

            <BackgroundProcessingInfo />
        </div>
    </div>
}

<CatalogChoiceDialog IsVisible="@showCatalogChoiceDialog"
                     OnCreateEmpty="OnCreateEmptyCatalogAsync"
                     OnCopyFromGlobal="OnCopyFromGlobalCatalogAsync"
                     OnClose="() => showCatalogChoiceDialog = false" />

@code {
    private List<string> tags = [];
    private bool isLoading = true;
    private bool isProcessing;
    private bool showCatalogChoiceDialog;
    private string? errorMessage;
    private string? successMessage;
    private string? googleUserId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            googleUserId = await GoogleUserService.GetGoogleUserIdAsync();
            await LoadTagsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to initialize: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTagsAsync()
    {
        try
        {
            var catalog = await PinsClient.GetTags(googleUserId!);
            tags = catalog.Tags.ToList();
        }
        catch (ApiException ex) when (ex.StatusCode == HttpStatusCode.NotFound)
        {
            // Catalog doesn't exist, show choice dialog
            showCatalogChoiceDialog = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load tags: {ex.Message}";
        }
    }

    private async Task OnCreateEmptyCatalogAsync()
    {
        await ExecuteApiOperationAsync(
            async () =>
            {
                await PinsClient.DefineTags(googleUserId!, new TagsDto());
                tags = [];
                return "Your empty tag catalog has been created successfully.";
            },
            conflictMessage: "Your tag catalog is already set up and ready to use."
        );
    }

    private async Task OnCopyFromGlobalCatalogAsync(List<string> globalTags)
    {
        await ExecuteApiOperationAsync(
            async () =>
            {
                await PinsClient.DefineTags(googleUserId!, new TagsDto { Tags = globalTags });
                tags = globalTags.ToList();
                return $"Your tag catalog has been created with {"tag".ToQuantity(globalTags.Count)} from the global catalog.";
            },
            conflictMessage: "Your tag catalog is already set up and ready to use."
        );
    }

    private async Task OnAddTagAsync(string tagName)
    {
        await ExecuteApiOperationAsync(
            async () =>
            {
                await PinsClient.AddTag(googleUserId!, new TagDto { Tag = tagName });
                tags.Add(tagName);
                return $"Tag '{tagName}' added successfully.";
            },
            notFoundMessage: "Tag catalog not found. Please refresh the page.",
            badRequestMessage: "Invalid tag name or tag already exists."
        );
    }

    private async Task OnRemoveTagAsync(string tag)
    {
        await ExecuteApiOperationAsync(
            async () =>
            {
                await PinsClient.RemoveTag(googleUserId!, new TagDto { Tag = tag });
                tags.Remove(tag);
                return $"Tag '{tag}' removed successfully.";
            },
            notFoundMessage: "Tag catalog not found. Please refresh the page."
        );
    }

    private async Task ExecuteApiOperationAsync(
        Func<Task<string>> operation,
        string? notFoundMessage = null,
        string? badRequestMessage = null,
        string? conflictMessage = null,
        Action? onConflict = null)
    {
        isProcessing = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            successMessage = await operation();
        }
        catch (ApiException ex) when (ex.StatusCode == HttpStatusCode.NotFound && notFoundMessage != null)
        {
            errorMessage = notFoundMessage;
        }
        catch (ApiException ex) when (ex.StatusCode == HttpStatusCode.BadRequest && badRequestMessage != null)
        {
            errorMessage = badRequestMessage;
        }
        catch (ApiException ex) when (ex.StatusCode == HttpStatusCode.Conflict && conflictMessage != null)
        {
            onConflict?.Invoke();
            successMessage = conflictMessage;
        }
        catch (Exception ex)
        {
            errorMessage = $"Operation failed: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void DismissError()
    {
        errorMessage = null;
    }

    private void DismissSuccess()
    {
        successMessage = null;
    }
}

